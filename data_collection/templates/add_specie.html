{% extends "data_collection/templates/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2 class="mb-3 text-primary">Add Species to Plantation</h2>
            <div id="message"></div>

            <form id="specieForm" method="post">
                {% csrf_token %}
                
                <!-- Added Plantation Dropdown -->
                <div class="mb-3">
                    <label for="plantationSelect" class="form-label">Select Plantation</label>
                    <select id="plantationSelect" name="plantation_id" class="form-control" required>
                        <option value="">-- Select Plantation --</option>
                        {% for plantation in plantations %}
                            <option value="{{ plantation.id }}" {% if plantation.has_species %}disabled{% endif %}>
                                {{ plantation.kyari_name }} (Farm: {{ plantation.farm.farm_name }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="specieSelect" class="form-label">Select Specie</label>
                    <select id="specieSelect" name="specie_id" class="form-control" required>
                        <option value="">-- Select Specie --</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Number of Plants</label>
                    {{ form.number_of_plants }}
                </div>

                <div class="mb-3">
                    <label class="form-label">Plant Spacing (e.g., "3_3")</label>
                    {{ form.plant_spacing }}
                </div>

                <h4 class="mt-3">Custom Spacing</h4>
                <div class="row">
                    <div class="col">
                        <label class="form-label">Spacing Right</label>
                        {{ form.spacing_cr }}
                    </div>
                    <div class="col">
                        <label class="form-label">Spacing Left</label>
                        {{ form.spacing_cl }}
                    </div>
                    <div class="col">
                        <label class="form-label">Spacing Top</label>
                        {{ form.spacing_ct }}
                    </div>
                    <div class="col">
                        <label class="form-label">Spacing Bottom</label>
                        {{ form.spacing_cb }}
                    </div>
                </div>
                <h4 class="mt-3">Upload Images</h4>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Centre Top</label>
                        {{ form.centre_top }}
                        <button type="button" class="btn btn-sm btn-info mt-1" onclick="showSample('top')">Sample</button>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Centre Bottom</label>
                        {{ form.centre_bottom }}
                        <button type="button" class="btn btn-sm btn-info mt-1" onclick="showSample('bottom')">Sample</button>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Centre Left</label>
                        {{ form.centre_left }}
                        <button type="button" class="btn btn-sm btn-info mt-1" onclick="showSample('left')">Sample</button>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Centre Right</label>
                        {{ form.centre_right }}
                        <button type="button" class="btn btn-sm btn-info mt-1" onclick="showSample('right')">Sample</button>
                    </div>
                </div>
              <!-- Sample Image Modal -->
                <div class="modal fade" id="sampleImageModal" tabindex="-1" aria-labelledby="sampleImageModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="sampleImageModalLabel">Sample Image</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="sampleImage" src="" class="img-fluid" alt="Sample Image">
                            </div>
                        </div>
                    </div>
                </div>


                <!-- New Field: Plantation Date -->
                <div class="mb-3">
                    <label class="form-label">Plantation Date</label>
                    <input type="date" id="plantationDate" name="plantation_date" class="form-control" required>
                </div>

                <button type="submit" class="btn btn-success mt-3 w-100">Submit</button>
            </form>

            <!-- Success/Error Message -->
            <div id="message"></div>
        </div>
    </div>
</div>
<script>
    function compressImage(file, quality, maxWidth, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(function(blob) {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    callback(compressedFile);
                }, 'image/jpeg', quality);
            };
        };
    }

    // Apply compression to all relevant image inputs
    document.querySelectorAll('input[type="file"][accept*="image"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) return;

            const label = this.previousElementSibling;
            const originalLabelText = label.textContent;
            label.textContent = `${originalLabelText} (Compressing...)`;

            compressImage(file, 0.6, 1280, (compressedFile) => {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(compressedFile);
                this.files = dataTransfer.files;

                label.textContent = originalLabelText;
                console.log(`Compressed ${file.name} from ${Math.round(file.size/1024)}KB to ${Math.round(compressedFile.size/1024)}KB`);
            });
        });
    });
</script>
<script>
    function showSample(position) {
        let sampleImages = {
            "top": "/static/sample_images/centre_top.jpg",
            "bottom": "/static/sample_images/centre_bottom.jpg",
            "left": "/static/sample_images/centre_left.jpg",
            "right": "/static/sample_images/centre_right.jpg"
        };

        document.getElementById("sampleImage").src = sampleImages[position];

        // Show modal using Bootstrap 5 method
        var modal = new bootstrap.Modal(document.getElementById("sampleImageModal"));
        modal.show();
    }
</script>

<!-- AJAX Form Submission -->
<script>
    document.getElementById("specieForm").addEventListener("submit", function(event) {
        event.preventDefault();
    
        var formData = new FormData(this);
        var farmerId = {{ farmer.id }};  // Get the farmer ID from context
    
        fetch(`/add-species/${farmerId}/`, {  // Updated URL to use farmer_id
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            let messageDiv = document.getElementById("message");
            messageDiv.innerHTML = ""; // Clear previous messages
    
            if (data.success) {
                messageDiv.innerHTML = `
                    <div class="alert alert-success mt-3">
                        <p>‚úÖ Species added successfully!</p>
                        <button id="addAnotherSpeciesBtn" class="btn btn-primary mt-2">‚ûï Add Another Species</button>
                        <button id="mediauploadBtn" class="btn btn-primary mt-2">üì∏ Upload Media</button>
                    </div>
                `;
    
                // Hide form after submission
                document.getElementById("specieForm").style.display = "none";
    
                // Add event listeners to buttons
                document.getElementById("addAnotherSpeciesBtn").addEventListener("click", addAnotherSpecies);
                document.getElementById("mediauploadBtn").addEventListener("click", function() {
                    window.location.href = `/upload-media/${farmerId}/`;
                });
            } else {
                // Display errors
                let errorHtml = '<div class="alert alert-danger mt-3">';
                if (typeof data.errors === 'object') {
                    errorHtml += '<ul>';
                    for (const [field, errors] of Object.entries(data.errors)) {
                        errorHtml += `<li>${field}: ${errors.join(', ')}</li>`;
                    }
                    errorHtml += '</ul>';
                } else {
                    errorHtml += `<p>${JSON.stringify(data.errors)}</p>`;
                }
                errorHtml += '</div>';
                messageDiv.innerHTML = errorHtml;
            }
        })
        .catch(error => {
            console.error("AJAX Error:", error);
            document.getElementById("message").innerHTML = `
                <div class="alert alert-danger mt-3">
                    <p>‚ùå An error occurred. Please try again.</p>
                </div>
            `;
        });
    });
    
    // Function to reset form and allow adding another species
    function addAnotherSpecies() {
        document.getElementById("specieForm").reset();  // Reset form
        document.getElementById("message").innerHTML = "";  // Clear success message
        document.getElementById("specieForm").style.display = "block";  // Show form again
    }
    document.addEventListener("DOMContentLoaded", function () {
        const specieSelect = document.getElementById("specieSelect");
    
        // Fetch species data from the backend
        fetch("/api/plantation/species/all/")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Populate the species dropdown
                data.forEach(specie => {
                    const option = document.createElement("option");
                    option.value = specie.id;
                    option.textContent = specie.display_name;
                    specieSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error fetching species data:", error);
                alert("Failed to load species data. Please try again later.");
            });
    
    });
</script>

{% endblock %}
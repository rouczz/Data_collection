{% extends "data_collection/templates/base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <h2 class="mb-3 text-primary">Add Species</h2>
            <!-- Success/Error Message -->
            <div id="message"></div>

            <!-- Species Form -->
            <form id="speciesForm" method="post">
                {% csrf_token %}
                <!-- Plantation Selection Dropdown -->
                <label for="plantationSelect">Select Plantation:</label>
                <select id="plantationSelect" name="plantation_id" class="form-control" required>
                    <option value="">-- Select Plantation --</option>
                </select>

                <!-- Species Details -->
                <label for="speciesName">Species Name:</label>
                <input type="text" id="speciesName" name="species_name" class="form-control" required />

                <!-- Spacing Inputs -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="spacingUp">Spacing Up (m):</label>
                        <input type="number" step="0.01" id="spacingUp" name="spacing_up" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label for="spacingDown">Spacing Down (m):</label>
                        <input type="number" step="0.01" id="spacingDown" name="spacing_down" class="form-control" required />
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="spacingLeft">Spacing Left (m):</label>
                        <input type="number" step="0.01" id="spacingLeft" name="spacing_left" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label for="spacingRight">Spacing Right (m):</label>
                        <input type="number" step="0.01" id="spacingRight" name="spacing_right" class="form-control" required />
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-3">Submit</button>
            </form>
        </div>
    </div>
</div>
<script>
    async function initDatabase() {
        if (typeof idb === 'undefined') {
            return Promise.reject(new Error("idb library not available"));
        }
        return idb.openDB('farmerApp', 1);
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Extract farmer_id from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const farmerId = urlParams.get('farmer_id');
            if (!farmerId) {
                alert('Farmer ID is missing. Please start from the Farmer page.');
                return;
            }
    
            const db = await initDatabase();
    
            // Fetch all plantations for the farmer
            const tx = db.transaction('plantations', 'readonly');
            const plantationIndex = tx.store.index('farmId'); // Use the index to query plantations by farm_id
            const plantations = await plantationIndex.getAll(parseInt(farmerId));
    
            // Fetch all species to find used plantation IDs
            const speciesTx = db.transaction('species', 'readonly');
            const species = await speciesTx.store.getAll();
            const usedPlantationIds = new Set(species.map(s => s.plantation_id)); // Track used plantations
    
            // Populate the plantation dropdown
            const plantationSelect = document.getElementById('plantationSelect');
            let hasAvailablePlantations = false;
            plantations.forEach(plantation => {
                if (!usedPlantationIds.has(plantation.id)) { // Exclude used plantations
                    const option = document.createElement('option');
                    option.value = plantation.id;
                    option.textContent = plantation.kyari_name; // Display plantation name
                    plantationSelect.appendChild(option);
                    hasAvailablePlantations = true;
                }
            });
    
            if (!hasAvailablePlantations) {
                alert('No available plantations for this farmer. Please create a new plantation.');
                plantationSelect.disabled = true; // Disable the dropdown if no plantations are available
            }
    
        } catch (error) {
            console.error('Error loading data:', error);
            alert('Failed to load data. Please refresh the page.');
        }
    });

    
    document.getElementById('speciesForm').addEventListener('submit', async (event) => {
        event.preventDefault();
    
        // Collect form data
        const formData = new FormData(event.target);
        const speciesData = {
            plantation_id: parseInt(formData.get('plantation_id')),
            species_name: formData.get('species_name'),
            spacing_up: parseFloat(formData.get('spacing_up')),
            spacing_down: parseFloat(formData.get('spacing_down')),
            spacing_left: parseFloat(formData.get('spacing_left')),
            spacing_right: parseFloat(formData.get('spacing_right')),
            timestamp: new Date().toISOString(),
            synced: false,
        };
    
        try {
            const db = await initDatabase();
            const tx = db.transaction('species', 'readwrite');
            const localId = await tx.store.add(speciesData); // Auto-generate ID
            await tx.done;
    
            alert('Species data saved offline.');
    
            // Display success message with a button to upload media
            const farmerId = new URLSearchParams(window.location.search).get('farmer_id');
            document.getElementById('message').innerHTML = `
                <div class="alert alert-success">
                    <p>Species added successfully!</p>
                    <button class="btn btn-primary mt-2" onclick="addAnotherSpecies()">Add Another Species</button>
                    <button class="btn btn-info mt-2" onclick="uploadMedia(${farmerId})">Upload Media</button>
                </div>
            `;
        } catch (error) {
            console.error('Error saving species data:', error);
            alert('Failed to save species data. Please try again.');
        }
    });
    
    function addAnotherSpecies() {
        document.getElementById('speciesForm').reset();
        document.getElementById('message').innerHTML = '';
    }
    
    function uploadMedia(farmerId) {
        if (!farmerId) {
            alert('Farmer ID is missing. Cannot proceed to media upload.');
            return;
        }
        window.location.href = `/media-upload/?farmer_id=${farmerId}`;
    }
    
</script>
{% endblock %}
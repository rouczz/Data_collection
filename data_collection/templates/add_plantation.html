{% extends "data_collection/templates/base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <h2 class="mb-3 text-primary">Add Plantation</h2>
            <!-- Success/Error Message -->
            <div id="message"></div>

            <!-- Plantation Form -->
            <form id="plantationForm" method="post">
                {% csrf_token %}
                <!-- Farm Selection Dropdown -->
                <label for="farmSelect">Select Farm:</label>
                <select id="farmSelect" name="farm_id" class="form-control" required>
                    <option value="">-- Select Farm --</option>
                </select>

                <!-- Species Dropdown -->
                <label for="speciesSelect">Select Species:</label>
                <select id="speciesSelect" name="species" class="form-control" required>
                    <option value="">-- Select Species --</option>
                </select>

                <!-- Plantation Details -->
                <label for="plantationName">Plantation Name:</label>
                <input type="text" id="plantationName" name="plantation_name" class="form-control" required />

                <label for="year">Year:</label>
                <input type="number" id="year" name="year" class="form-control" required />

                <label for="numberOfPlants">Number of Plants:</label>
                <input type="number" id="numberOfPlants" name="number_of_plants" class="form-control" required />

                <button type="submit" class="btn btn-primary mt-3">Submit</button>
            </form>
        </div>
    </div>
</div>

<script>
    async function initDatabase() {
        if (typeof idb === 'undefined') {
            return Promise.reject(new Error("idb library not available"));
        }
        return idb.openDB('farmerApp', 1);
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Extract farmer_id from the URL
            
            const urlParams = new URLSearchParams(window.location.search);
            const farmerId = urlParams.get('farmer_id');
            if (!farmerId) {
                alert('Farmer ID is missing. Please start from the Farmer page.');
                return;
            }
    
            // Initialize IndexedDB
            const db = await initDatabase();
    
            // Populate farms dropdown
            const farmTx = db.transaction('farms', 'readonly');
            const farmIndex = farmTx.store.index('farmerId'); // Use the index to query farms by farmer_id
            const farms = await farmIndex.getAll(parseInt(farmerId));
            const farmSelect = document.getElementById('farmSelect');
    
            farms.forEach(farm => {
                const option = document.createElement('option');
                option.value = farm.id;
                option.textContent = farm.farm_name;
                farmSelect.appendChild(option);
            });
    
            // Populate species dropdown with random species
            const species = ['Mango', 'Apple', 'Banana', 'Orange', 'Grapes'];
            const speciesSelect = document.getElementById('speciesSelect');
            species.forEach(specie => {
                const option = document.createElement('option');
                option.value = specie;
                option.textContent = specie;
                speciesSelect.appendChild(option);
            });
    
        } catch (error) {
            console.error('Error loading data:', error);
            alert('Failed to load data. Please refresh the page.');
        }
    });
    
    // Handle form submission
    document.getElementById('plantationForm').addEventListener('submit', async (event) => {
        event.preventDefault();
    
        // Extract query parameters from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const farmerId = urlParams.get('farmer_id');
        if (!farmerId) {
            alert('Farmer ID is missing. Cannot proceed.');
            return;
        }
    
        // Collect form data
        const formData = new FormData(event.target);
        const plantationData = {
            farm_id: parseInt(formData.get('farm_id')),
            species: formData.get('species'),
            plantation_name: formData.get('plantation_name'),
            year: parseInt(formData.get('year')),
            number_of_plants: parseInt(formData.get('number_of_plants')),
            timestamp: new Date().toISOString(),
            synced: false,
        };
    
        try {
            const db = await initDatabase();
            const tx = db.transaction('plantations', 'readwrite');
            const localId = await tx.store.add(plantationData); // Auto-generate ID
            await tx.done;
    
            alert('Plantation saved offline.');
    
            // Display success message
            document.getElementById('message').innerHTML = `
                <div class="alert alert-success">
                    <p>Plantation created successfully!</p>
                    <button class="btn btn-primary mt-2" onclick="addAnotherPlantation()">Add Another Plantation</button>
                    <button class="btn btn-success mt-2" onclick="proceedToSpecies(${farmerId})">Proceed to Species</button>
                </div>
            `;
        } catch (error) {
            console.error('Error saving plantation data:', error);
            alert('Failed to save plantation data. Please try again.');
        }
    });
    
    // Function to add another plantation
    function addAnotherPlantation() {
        document.getElementById('plantationForm').reset();
        document.getElementById('message').innerHTML = '';
        document.getElementById('plantationForm').style.display = 'block';

    }
    
    // Function to proceed to species page
    function proceedToSpecies(farmerId) {
        if (!farmerId) {
            alert('Farmer ID is missing. Cannot proceed to species.');
            return;
        }
        window.location.href = `/add-species/?farmer_id=${farmerId}`;
    }

</script>
{% endblock %}